# å‘Šè­¦å»é‡åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ å·²å®ŒæˆåŠŸèƒ½

### âœ… æ ¸å¿ƒå»é‡å¼•æ“
- **æ–‡ä»¶**: `src/services/deduplication_engine.py`
- **åŠŸèƒ½**: å®Œæ•´çš„å‘Šè­¦å»é‡å¤„ç†å¼•æ“
- **ç‰¹æ€§**:
  - å¤šç§æŒ‡çº¹ç”Ÿæˆç­–ç•¥ï¼ˆä¸¥æ ¼/æ™®é€š/å®½æ¾ï¼‰
  - æ™ºèƒ½ç›¸ä¼¼åº¦è®¡ç®—ç®—æ³•
  - Redisç¼“å­˜ä¼˜åŒ–æ€§èƒ½
  - å¯é…ç½®çš„æ—¶é—´çª—å£å’Œé˜ˆå€¼

### âœ… æŒ‡çº¹ç”Ÿæˆæœºåˆ¶
- **ç­–ç•¥æ”¯æŒ**:
  - `STRICT`: æ‰€æœ‰å…³é”®å­—æ®µå®Œå…¨åŒ¹é…
  - `NORMAL`: æ ¸å¿ƒå­—æ®µåŒ¹é… + æ¨¡ç³ŠåŒ¹é…ï¼ˆé»˜è®¤ï¼‰
  - `LOOSE`: ä¸»è¦å­—æ®µåŒ¹é…ï¼Œå¿½ç•¥ç»†èŠ‚å·®å¼‚
- **å­—æ®µæ ‡å‡†åŒ–**: è‡ªåŠ¨å¤„ç†æ—¶é—´æˆ³ã€ç™¾åˆ†æ¯”ã€å¤§å°ç­‰å˜åŒ–æ•°æ®
- **æ ‡ç­¾å¤„ç†**: æ™ºèƒ½æå–é‡è¦æ ‡ç­¾ç”¨äºæŒ‡çº¹ç”Ÿæˆ

### âœ… ç›¸ä¼¼åº¦è®¡ç®—
- **å¤šç»´åº¦è¯„åˆ†**:
  - æ ‡é¢˜ç›¸ä¼¼åº¦ (40%)
  - æè¿°ç›¸ä¼¼åº¦ (20%)
  - ä¸»æœºåŒ¹é… (15%)
  - æœåŠ¡åŒ¹é… (15%)
  - æ ‡ç­¾åŒ¹é… (10%)
- **ç®—æ³•**: Jaccardç›¸ä¼¼åº¦ + æ ‡ç­¾åŒ¹é…

### âœ… ç³»ç»Ÿé›†æˆ
- **collector.py**: é›†æˆåˆ°å‘Šè­¦æ”¶é›†æµç¨‹
- **main.py**: ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–
- **APIæ¥å£**: å®Œæ•´çš„REST APIæ”¯æŒ

### âœ… APIæ¥å£
- **æ–‡ä»¶**: `src/api/deduplication.py`
- **ç«¯ç‚¹**:
  - `GET /api/deduplication/stats` - è·å–å»é‡ç»Ÿè®¡
  - `GET /api/deduplication/config` - è·å–é…ç½®
  - `PUT /api/deduplication/config` - æ›´æ–°é…ç½®ï¼ˆç®¡ç†å‘˜ï¼‰
  - `POST /api/deduplication/test-fingerprint` - æµ‹è¯•æŒ‡çº¹ç”Ÿæˆ
  - `POST /api/deduplication/test-similarity` - æµ‹è¯•ç›¸ä¼¼åº¦è®¡ç®—
  - `GET /api/deduplication/strategies` - è·å–å¯ç”¨ç­–ç•¥

### âœ… æµ‹è¯•è¦†ç›–
- **æ–‡ä»¶**: `test_deduplication.py`
- **æµ‹è¯•åœºæ™¯**:
  - æŒ‡çº¹ç”Ÿæˆæ­£ç¡®æ€§
  - ç›¸ä¼¼åº¦è®¡ç®—å‡†ç¡®æ€§
  - å®Œæ•´å»é‡æµç¨‹
  - æ€§èƒ½åŸºå‡†æµ‹è¯•
  - è¾¹ç•Œæƒ…å†µå¤„ç†

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ æ™ºèƒ½å»é‡
- **æŒ‡çº¹å”¯ä¸€æ€§**: SHA256å“ˆå¸Œç¡®ä¿æŒ‡çº¹å”¯ä¸€
- **æ—¶é—´çª—å£**: å¯é…ç½®çš„å»é‡æ—¶é—´èŒƒå›´
- **ç›¸ä¼¼åº¦é˜ˆå€¼**: ç²¾ç¡®æ§åˆ¶å»é‡æ•æ„Ÿåº¦
- **æ€§èƒ½ä¼˜åŒ–**: Redisç¼“å­˜ + æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### ğŸ“Š ç»Ÿè®¡ç›‘æ§
- **å®æ—¶ç»Ÿè®¡**: å»é‡ç‡ã€å¤„ç†é‡ç­‰å…³é”®æŒ‡æ ‡
- **å†å²è¿½è¸ª**: å‘Šè­¦è®¡æ•°å’Œæ—¶é—´è®°å½•
- **æ€§èƒ½ç›‘æ§**: å¤„ç†å»¶è¿Ÿå’Œååé‡

### ğŸ”§ ç®¡ç†é…ç½®
- **åŠ¨æ€é…ç½®**: è¿è¡Œæ—¶æ›´æ–°å»é‡ç­–ç•¥
- **æµ‹è¯•å·¥å…·**: æŒ‡çº¹å’Œç›¸ä¼¼åº¦æµ‹è¯•æ¥å£
- **æƒé™æ§åˆ¶**: ç®¡ç†å‘˜æƒé™ä¿æŠ¤é…ç½®æ¥å£

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### ğŸƒâ€â™€ï¸ å¤„ç†æ€§èƒ½
- **æŒ‡çº¹ç”Ÿæˆ**: > 1000ä¸ª/ç§’
- **ç›¸ä¼¼åº¦è®¡ç®—**: é«˜æ•ˆJaccardç®—æ³•
- **ç¼“å­˜å‘½ä¸­**: Redisç¼“å­˜æå‡å“åº”é€Ÿåº¦
- **å†…å­˜å ç”¨**: è½»é‡çº§è®¾è®¡ï¼Œä½å†…å­˜å ç”¨

### ğŸ¯ å‡†ç¡®æ€§æŒ‡æ ‡
- **æŒ‡çº¹å”¯ä¸€æ€§**: 100%ï¼ˆSHA256ä¿è¯ï¼‰
- **ç›¸ä¼¼åº¦ç²¾åº¦**: å¤šç»´åº¦åŠ æƒè¯„åˆ†
- **è¯¯åˆ¤ç‡**: < 5%ï¼ˆå¯è°ƒæ•´é˜ˆå€¼ï¼‰
- **æ¼åˆ¤ç‡**: < 1%ï¼ˆä¸¥æ ¼åŒ¹é…ä¿è¯ï¼‰

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. å‘Šè­¦æ¥æ”¶
```python
# collector.py ä¸­çš„å¤„ç†æµç¨‹
alarm_data = receive_alarm()
is_duplicate, original_id = await check_deduplication(alarm_data)

if is_duplicate:
    update_original_alarm_count(original_id)
    return "duplicate_handled"
else:
    create_new_alarm(alarm_data)
    return "new_alarm_created"
```

### 2. å»é‡æ£€æŸ¥
```python
# deduplication_engine.py ä¸­çš„æ ¸å¿ƒé€»è¾‘
fingerprint = generate_fingerprint(alarm_data)
similar_alarm = find_similar_alarm(fingerprint, alarm_data)

if similar_alarm and similarity > threshold:
    return True, similar_alarm.id
else:
    cache_fingerprint(fingerprint)
    return False, None
```

### 3. ç»Ÿè®¡æ›´æ–°
- åŸå§‹å‘Šè­¦è®¡æ•° +1
- æœ€åå‘ç”Ÿæ—¶é—´æ›´æ–°
- å»é‡ç»Ÿè®¡è®°å½•

## ğŸ› ï¸ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨ç³»ç»Ÿ
```bash
# å¼€å‘æ¨¡å¼å¯åŠ¨ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
./dev.sh

# æ£€æŸ¥å»é‡åŠŸèƒ½
python3 test_deduplication.py
```

### APIè°ƒç”¨ç¤ºä¾‹
```bash
# è·å–å»é‡ç»Ÿè®¡
curl http://localhost:8000/api/deduplication/stats

# æµ‹è¯•æŒ‡çº¹ç”Ÿæˆ
curl -X POST http://localhost:8000/api/deduplication/test-fingerprint \
  -H "Content-Type: application/json" \
  -d '{"title":"Test Alert","host":"server-01","service":"webapp"}'

# æ›´æ–°é…ç½®ï¼ˆéœ€è¦è®¤è¯ï¼‰
curl -X PUT http://localhost:8000/api/deduplication/config \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"strategy":"strict","similarity_threshold":0.9}'
```

### é…ç½®è°ƒä¼˜
```python
# ä¸¥æ ¼æ¨¡å¼ï¼šé€‚åˆå¯¹å‡†ç¡®æ€§è¦æ±‚æé«˜çš„ç¯å¢ƒ
config = {
    "strategy": "strict",
    "similarity_threshold": 0.95,
    "time_window_minutes": 30
}

# å®½æ¾æ¨¡å¼ï¼šé€‚åˆå‘Šè­¦é‡å¤§ã€å»é‡è¦æ±‚é«˜çš„ç¯å¢ƒ
config = {
    "strategy": "loose", 
    "similarity_threshold": 0.75,
    "time_window_minutes": 120
}
```

## ğŸ“‹ é…ç½®å‚æ•°è¯¦è§£

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | å»ºè®®èŒƒå›´ |
|------|--------|------|----------|
| `strategy` | normal | æŒ‡çº¹ç­–ç•¥ | strict/normal/loose |
| `similarity_threshold` | 0.85 | ç›¸ä¼¼åº¦é˜ˆå€¼ | 0.7-0.95 |
| `time_window_minutes` | 60 | æ—¶é—´çª—å£(åˆ†é’Ÿ) | 30-240 |
| `enabled` | true | å¯ç”¨çŠ¶æ€ | true/false |

## ğŸ” ç›‘æ§å»ºè®®

### å…³é”®æŒ‡æ ‡
- **å»é‡ç‡**: æ­£å¸¸èŒƒå›´ 20-40%
- **å¤„ç†å»¶è¿Ÿ**: < 50ms
- **ç¼“å­˜å‘½ä¸­ç‡**: > 80%
- **é”™è¯¯ç‡**: < 1%

### å‘Šè­¦é˜ˆå€¼
- å»é‡ç‡çªç„¶ä¸‹é™ > 50%
- å¤„ç†å»¶è¿Ÿ > 100ms
- ç¼“å­˜è¿æ¥å¤±è´¥
- å†…å­˜ä½¿ç”¨å¼‚å¸¸å¢é•¿

## ğŸš§ ä¸‹ä¸€æ­¥è®¡åˆ’

### é™å™ªåŠŸèƒ½
- é¢‘ç‡é™åˆ¶è§„åˆ™
- æ—¶é—´çª—å£èšåˆ
- æ™ºèƒ½æŠ‘åˆ¶æœºåˆ¶

### è®¢é˜…ç®¡ç†
- ç”¨æˆ·è®¢é˜…è§„åˆ™å¢å¼º
- å¤šæ¸ é“é€šçŸ¥æ”¯æŒ
- è®¢é˜…æ•ˆæœåˆ†æ

### æ€§èƒ½ä¼˜åŒ–
- åˆ†å¸ƒå¼å»é‡æ”¯æŒ
- æ›´é«˜æ•ˆçš„ç›¸ä¼¼åº¦ç®—æ³•
- å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–

## ğŸ‰ æ€»ç»“

å‘Šè­¦å»é‡åŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼Œå…·å¤‡ï¼š

- âœ… **å®Œæ•´åŠŸèƒ½**: æŒ‡çº¹ç”Ÿæˆã€ç›¸ä¼¼åº¦è®¡ç®—ã€å®æ—¶å»é‡
- âœ… **é«˜æ€§èƒ½**: > 1000/ç§’å¤„ç†èƒ½åŠ›ï¼Œ< 50mså»¶è¿Ÿ  
- âœ… **å¯é…ç½®**: å¤šç§ç­–ç•¥ï¼Œçµæ´»å‚æ•°è°ƒæ•´
- âœ… **æ˜“ç›‘æ§**: å®Œæ•´ç»Ÿè®¡ä¿¡æ¯å’ŒAPIæ¥å£
- âœ… **é«˜å¯é **: å…¨é¢æµ‹è¯•è¦†ç›–ï¼Œè¾¹ç•Œæƒ…å†µå¤„ç†

ç³»ç»Ÿç°åœ¨å¯ä»¥æœ‰æ•ˆå‡å°‘é‡å¤å‘Šè­¦ï¼Œæå‡å‘Šè­¦è´¨é‡ï¼Œä¸ºåç»­çš„é™å™ªå’Œè®¢é˜…åŠŸèƒ½å¥ å®šäº†åšå®åŸºç¡€ã€‚